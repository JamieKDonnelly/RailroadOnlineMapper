class Mapper{constructor(t){this.svgNS="http://www.w3.org/2000/svg",this.svgTag=null,this.shapes=[],this.json=t,this.drawMaxSlope=!0,this.imageWidth=8e3,this.minX=-2e5,this.maxX=2e5,this.minY=-2e5,this.maxY=2e5,this.x=this.maxX-this.minX,this.y=this.maxY-this.minY,this.max=Math.max(this.x,this.y),this.scale=100*this.imageWidth/this.max,this.switchRadius=80/2.2107077*this.scale,this.engineRadius=6*this.scale,this.turnTableRadius=10/2.2107077*this.scale,this.imx=this.x/100*this.scale,this.imy=this.y/100*this.scale,this.maxSlope=0,this.allLabels=[[0,0]],this.initialTreesDown=1750}drawSVG(t){this.svgTag=document.getElementById(t),this.getReplantableTrees(),this.getTracksAndBeds(),this.getSwitches(),this.getTurntables(),this.getRollingStock(),this.getIndustries(),this.getWaterTowers(),this.populatePlayerTable();for(const t of this.shapes)this.svgTag.appendChild(t)}populatePlayerTable(){if(!("Players"in this.json))return null;const t=document.getElementById("playerTable"),e=document.getElementById("editPlayersTable");for(let s=0;s<this.json.Players.length;s++){const i=this.json.Players[s],o=document.createElement("tr"),r=document.createElement("td"),n=document.createTextNode(i.Name);r.appendChild(n),o.appendChild(r);const a=document.createElement("td"),d=document.createTextNode(i.Xp);a.appendChild(d),o.appendChild(a);const h=document.createElement("td"),c=document.createTextNode(i.Money);h.appendChild(c),o.appendChild(h),t.appendChild(o);const u=document.createElement("tr"),l=document.createElement("td"),p=document.createTextNode(i.Name);l.appendChild(p),u.appendChild(l);const m=document.createElement("td"),b=document.createElement("input");b.size=5,b.maxLength=15,b.name="xp_"+s,b.value=i.Xp,m.appendChild(b),u.appendChild(m);const g=document.createElement("td"),S=document.createElement("input");S.size=5,S.maxLength=15,S.name="money_"+s,S.value=i.Money,g.appendChild(S),u.appendChild(g);const A=document.createElement("td");let f=document.createTextNode("Unknown");"Industries"in this.json&&(f=document.createTextNode(this._nearestIndustry(i.Location,this.json.Industries))),A.appendChild(f),u.appendChild(A);const M=document.createElement("td"),k=document.createElement("input");k.type="checkbox",k.name="deletePlayer_"+s,M.appendChild(k),u.appendChild(M),e.appendChild(u)}}getTracksAndBeds(){const t=document.createElementNS(this.svgNS,"g"),e=document.createElementNS(this.svgNS,"g"),s=document.createElementNS(this.svgNS,"g");t.setAttribute("class","tracks display_show"),e.setAttribute("class","beds display_show");const i=Array(document.createElementNS(this.svgNS,"g"),document.createElementNS(this.svgNS,"g"),document.createElementNS(this.svgNS,"g"),document.createElementNS(this.svgNS,"g"));i[0].setAttribute("class","slopeLabel0 display_hide"),i[1].setAttribute("class","slopeLabel1 display_hide"),i[2].setAttribute("class","slopeLabel2 display_show"),i[3].setAttribute("class","slopeLabel3 display_show"),s.setAttribute("class","maxSlopeLabel display_show");const o={1:[1,15,"darkkhaki",2],2:[2,15,"darkkhaki",2],5:[5,15,"darkgrey",3],6:[6,15,"darkgrey",3],7:[7,15,"lightblue",4],3:[3,15,"orange",5],4:[4,3,"black",8],0:[0,3,"black",8]};let r=[0,0];if("Splines"in this.json)for(const s of this.json.Splines){let n=s.Type,a=o[n];const[d,h,c,u]=a;let l=s.Segments;if([1,2,5,6,3,7].indexOf(n)>-1){const t=document.createElementNS(this.svgNS,"path");let s="",i="";for(const t of l){i=1!==t.Visible?"M":"L";let e=this.imx-(t.LocationStart.X-this.minX)/100*this.scale,o=this.imy-(t.LocationStart.Y-this.minY)/100*this.scale,r=this.imx-(t.LocationEnd.X-this.minX)/100*this.scale,n=this.imy-(t.LocationEnd.Y-this.minY)/100*this.scale;this.imx,t.LocationCenter.X,this.minX,this.scale,this.imy,t.LocationCenter.Y,this.minY,this.scale;""===s?(s="M "+e+","+o+" ",s+=i+" "+r+","+n+" "):s+=i+" "+r+","+n+" "}t.setAttribute("d",s),t.setAttribute("style","z-index:"+u),t.setAttribute("fill","none"),t.setAttribute("stroke",c),t.setAttribute("stroke-width",h.toString()),3===n?t.setAttribute("class","wooden"):7===n&&t.setAttribute("class","iron"),e.appendChild(t)}else for(const e of l){if(1!==e.Visible)continue;let s=this.imx-(e.LocationStart.X-this.minX)/100*this.scale,o=this.imy-(e.LocationStart.Y-this.minY)/100*this.scale,a=this.imx-(e.LocationEnd.X-this.minX)/100*this.scale,d=this.imy-(e.LocationEnd.Y-this.minY)/100*this.scale,u=this.imx-(e.LocationCenter.X-this.minX)/100*this.scale,l=this.imy-(e.LocationCenter.Y-this.minY)/100*this.scale;const p=document.createElementNS(this.svgNS,"line");p.setAttribute("x1",s.toString()),p.setAttribute("y1",o.toString()),p.setAttribute("x2",a.toString()),p.setAttribute("y2",d.toString()),p.setAttribute("stroke",c),p.setAttribute("stroke-width",h.toString()),t.appendChild(p);let m=Math.sqrt(Math.pow(e.LocationEnd.X-e.LocationStart.X,2)+Math.pow(e.LocationEnd.Y-e.LocationStart.Y,2)+Math.pow(e.LocationEnd.Z-e.LocationStart.Z,2)),b=0;if(n in[4,0]){const s=Math.abs(e.LocationEnd.Z-e.LocationStart.Z),i=Math.sqrt(Math.pow(e.LocationEnd.X-e.LocationStart.X,2)+Math.pow(e.LocationEnd.Y-e.LocationStart.Y,2));if(null==i||0===i||0===i){const e=document.createElementNS(this.svgNS,"circle");e.setAttribute("cx",u.toString()),e.setAttribute("cy",l.toString()),e.setAttribute("r","10"),e.setAttribute("stroke","red"),e.setAttribute("stroke-width","2"),e.setAttribute("fill","red"),t.appendChild(e);continue}(b=100*s/i)>this.maxSlope&&(r=[u,l]),this.maxSlope=Math.max(this.maxSlope,b)}const g="..",S=1;if(m>0&&(4===n||0===n)){let t=null;e.LocationEnd.X===e.LocationStart.X&&(t=90);const s=(e.LocationEnd.Y-e.LocationStart.Y)/(e.LocationEnd.X-e.LocationStart.X);if((t=this._rad2deg(Math.atan(s)))>0?t-=90:t+=90,this._getDistanceToNearestLabel([u,l])>60){let e=this._round(b,S),s=Math.min(3,Math.floor(b));this.allLabels.push([u,l]);const o=document.createElementNS(this.svgNS,"text"),r=document.createTextNode(g+e+"%");o.setAttribute("x",u.toString()),o.setAttribute("y",l.toString()),o.setAttribute("transform","rotate("+t+","+u+","+l+")"),o.appendChild(r),i[s].appendChild(o)}}}}if(this.drawMaxSlope)for(const t in[5,4,3,2]){const e=document.createElementNS(this.svgNS,"circle");e.setAttribute("cx",r[0].toString()),e.setAttribute("cy",r[1].toString()),e.setAttribute("r",(this.turnTableRadius*t).toString()),e.setAttribute("stroke","orange"),e.setAttribute("stroke-width","5"),e.setAttribute("fill","none"),s.appendChild(e),this.shapes.push(s)}this.shapes.push(e),this.shapes.push(t),this.shapes.push(i[0]),this.shapes.push(i[1]),this.shapes.push(i[2]),this.shapes.push(i[3])}getSwitches(){if(!("Switchs"in this.json))return;const t=document.createElementNS(this.svgNS,"g");t.setAttribute("class","switches display_show");for(const e of this.json.Switchs){let s=!1;const i=e.Type;let o=e.Side;switch(i){case 0:s=-7,o=!o;break;case 1:case 3:case 4:s=7;break;case 2:s=-7;break;case 5:o=!o,s=-7;break;case 6:s=99;break;default:s=1}s||console.log("Switch error in switch "+e);const r=this._deg2rad(e.Rotation[1]-90),n=this._deg2rad(e.Rotation[1]-90+s),a=this._deg2rad(e.Rotation[1]+180),d=this.imx-(e.Location[0]-this.minX)/100*this.scale,h=this.imy-(e.Location[1]-this.minY)/100*this.scale;if(99===s){const s=this.switchRadius/10,i=this.imx-(e.Location[0]-this.minX)/100*this.scale+Math.cos(a)*s,o=this.imy-(e.Location[1]-this.minY)/100*this.scale+Math.sin(a)*s,n=d+(i-d)/2,c=h+(o-h)/2;let u=document.createElementNS(this.svgNS,"line");u.setAttribute("x1",d.toString()),u.setAttribute("y1",h.toString()),u.setAttribute("x2",i.toString()),u.setAttribute("y2",o.toString()),u.setAttribute("stroke","black"),u.setAttribute("stroke-width","3"),t.appendChild(u),(u=document.createElementNS(this.svgNS,"line")).setAttribute("x1",(n-Math.cos(r)*s).toString()),u.setAttribute("y1",(c-Math.sin(r)*s).toString()),u.setAttribute("x2",(n+Math.cos(r)*s).toString()),u.setAttribute("y2",(c+Math.sin(r)*s).toString()),u.setAttribute("stroke","black"),u.setAttribute("stroke-width","3"),t.appendChild(u)}else{const s=this.imx-(e.Location[0]-this.minX)/100*this.scale+Math.cos(r)*this.switchRadius/2,i=this.imy-(e.Location[1]-this.minY)/100*this.scale+Math.sin(r)*this.switchRadius/2,a=this.imx-(e.Location[0]-this.minX)/100*this.scale+Math.cos(n)*this.switchRadius/2,c=this.imy-(e.Location[1]-this.minY)/100*this.scale+Math.sin(n)*this.switchRadius/2;if(o){let e=document.createElementNS(this.svgNS,"line");e.setAttribute("x1",d.toString()),e.setAttribute("y1",h.toString()),e.setAttribute("x2",s.toString()),e.setAttribute("y2",i.toString()),e.setAttribute("stroke","red"),e.setAttribute("stroke-width","3"),t.appendChild(e),(e=document.createElementNS(this.svgNS,"line")).setAttribute("x1",d.toString()),e.setAttribute("y1",h.toString()),e.setAttribute("x2",a.toString()),e.setAttribute("y2",c.toString()),e.setAttribute("stroke","black"),e.setAttribute("stroke-width","3"),t.appendChild(e)}else{let e=document.createElementNS(this.svgNS,"line");e.setAttribute("x1",d.toString()),e.setAttribute("y1",h.toString()),e.setAttribute("x2",a.toString()),e.setAttribute("y2",c.toString()),e.setAttribute("stroke","red"),e.setAttribute("stroke-width","3"),t.appendChild(e),(e=document.createElementNS(this.svgNS,"line")).setAttribute("x1",d.toString()),e.setAttribute("y1",h.toString()),e.setAttribute("x2",s.toString()),e.setAttribute("y2",i.toString()),e.setAttribute("stroke","black"),e.setAttribute("stroke-width","3"),t.appendChild(e)}}}this.shapes.push(t)}getTurntables(){if(!("Turntables"in this.json))return;const t=document.createElementNS(this.svgNS,"g");t.setAttribute("class","turntables display_show");for(const e of this.json.Turntables){const s=this._deg2rad(e.Rotator[1]+90),i=this._deg2rad(e.Rotator[1]+90-e.Deck[1]);this.turnTableRadius=25;const o=this.imx-(e.Location[0]-this.minX)/100*this.scale,r=this.imx-(e.Location[1]-this.minX)/100*this.scale,n=o+(this.imx-(e.Location[0]-this.minX)/100*this.scale+Math.cos(s)*this.turnTableRadius-o)/2,a=r+(this.imy-(e.Location[1]-this.minY)/100*this.scale+Math.sin(s)*this.turnTableRadius-r)/2,d=document.createElementNS(this.svgNS,"circle");d.setAttribute("cx",n.toString()),d.setAttribute("cy",a.toString()),d.setAttribute("r",(this.turnTableRadius/2).toString()),d.setAttribute("stroke","black"),d.setAttribute("stroke-width","1"),d.setAttribute("fill","lightyellow"),t.appendChild(d);const h=document.createElementNS(this.svgNS,"line");h.setAttribute("x1",(n-Math.cos(i)*this.turnTableRadius/2).toString()),h.setAttribute("y1",(a-Math.sin(i)*this.turnTableRadius/2).toString()),h.setAttribute("x2",(n+Math.cos(i)*this.turnTableRadius/2).toString()),h.setAttribute("y2",(a+Math.sin(i)*this.turnTableRadius/2).toString()),h.setAttribute("stroke","black"),h.setAttribute("stroke-width","3"),t.appendChild(h)}this.shapes.push(t)}getRollingStock(){if(!("Frames"in this.json))return;const t=document.createElementNS(this.svgNS,"g");t.setAttribute("class","rollingstock display_show");const e=document.getElementById("undergroundCartsTable"),s=document.getElementById("rollingStockTable"),i={flatcar_logs:["log","steelpipe"],flatcar_stakes:["rail","lumber","beam","rawiron"],flatcar_hopper:["ironore","coal"],flatcar_cordwood:["cordwood","oilbarrel"],flatcar_tanker:["crudeoil"],boxcar:["crate_tools"]},o={log:"Logs",cordwood:"Cordwood",beam:"Beams",lumber:"Lumber",ironore:"Iron Ore",rail:"Rails",rawiron:"Raw Iron",coal:"Coal",steelpipe:"Steel Pipes",crate_tools:"Tools",crudeoil:"Crude Oil",oilbarrel:"Oil Barrels"},r={handcar:[this.engineRadius,"white"],porter_040:[this.engineRadius,"black"],porter_042:[this.engineRadius,"black"],eureka:[this.engineRadius,"black"],eureka_tender:[this.engineRadius,"black"],climax:[this.engineRadius,"black"],heisler:[this.engineRadius,"black"],class70:[this.engineRadius,"black"],class70_tender:[this.engineRadius,"black"],cooke260:[this.engineRadius,"black"],cooke260_tender:[this.engineRadius,"black"],flatcar_logs:[this.engineRadius/3,"red"],flatcar_cordwood:[this.engineRadius/3*2,"orange"],flatcar_stakes:[this.engineRadius/3*2,"yellow"],flatcar_hopper:[this.engineRadius/3*2,"brown"],boxcar:[this.engineRadius/3*2,"purple"],flatcar_tanker:[this.engineRadius/3*2,"grey"]};let n=0;for(const a of this.json.Frames){const d=this.imx-(a.Location[0]-this.minX)/100*this.scale,h=this.imy-(a.Location[1]-this.minY)/100*this.scale;if(["porter_040","porter_042","eureka","climax","heisler","class70","cooke260"].indexOf(a.Type)>=0){const e=this.engineRadius/3*2,s=this.engineRadius/2*2,i=document.createElementNS(this.svgNS,"path");i.setAttribute("transform","rotate("+Math.round(a.Rotation[1])+", "+d+", "+h+")"),i.setAttribute("d","M"+(d-this.engineRadius/2)+","+h+" l "+s/3+","+e/2+" l "+s/3*2+",0 l 0,-"+e+" l -"+s/3*2+",0 z"),i.setAttribute("fill","purple"),i.setAttribute("stroke","black"),i.setAttribute("stroke-width","2"),t.appendChild(i)}else{const e=this.engineRadius/3*2;let s=this.engineRadius;-1!==a.Type.toLowerCase().indexOf("tender")&&(s=s/3*2);const i=document.createElementNS(this.svgNS,"path");if(i.setAttribute("d","M"+Math.round(d)+","+Math.round(h)+" m-"+s/2+",-"+e/2+" h"+(s-4)+" a2,2 0 0 1 2,2 v"+(e-4)+" a2,2 0 0 1 -2,2 h-"+(s-4)+" a2,2 0 0 1 -2,-2 v-"+(e-4)+" a2,2 0 0 1 2,-2 z"),i.setAttribute("fill",r[a.Type][1]),i.setAttribute("stroke","black"),i.setAttribute("stroke-width","1"),i.setAttribute("transform","rotate("+Math.round(a.Rotation[1])+", "+Math.round(d)+", "+Math.round(h)+")"),t.appendChild(i),-1!==a.Type.toLowerCase().indexOf("flatcar_stakes")&&-1!==a.Freight.Type.toLowerCase().indexOf("lumber")){let e=5,s=2;if(a.Freight.Amount>0){const i=document.createElementNS(this.svgNS,"path");i.setAttribute("d","M"+Math.round(d)+","+Math.round(h)+" m-6,-3 h"+e+" v"+s+" h-"+e+" z"),i.setAttribute("stroke","brown"),i.setAttribute("stroke-width","1"),i.setAttribute("transform","rotate("+Math.round(a.Rotation[1])+", "+Math.round(d)+", "+Math.round(h)+")"),t.appendChild(i)}if(a.Freight.Amount>1){const i=document.createElementNS(this.svgNS,"path");i.setAttribute("d","M"+Math.round(d)+","+Math.round(h)+" m-6,-1 h"+e+" v"+s+" h-"+e+" z"),i.setAttribute("fill",r[a.Type][1]),i.setAttribute("stroke","brown"),i.setAttribute("stroke-width","1"),i.setAttribute("transform","rotate("+Math.round(a.Rotation[1])+", "+Math.round(d)+", "+Math.round(h)+")"),t.appendChild(i)}if(a.Freight.Amount>2){const i=document.createElementNS(this.svgNS,"path");i.setAttribute("d","M"+Math.round(d)+","+Math.round(h)+" m-6,1 h"+e+" v"+s+" h-"+e+" z"),i.setAttribute("fill",r[a.Type][1]),i.setAttribute("stroke","brown"),i.setAttribute("stroke-width","1"),i.setAttribute("transform","rotate("+Math.round(a.Rotation[1])+", "+Math.round(d)+", "+Math.round(h)+")"),t.appendChild(i)}if(a.Freight.Amount>3){const i=document.createElementNS(this.svgNS,"path");i.setAttribute("d","M"+Math.round(d)+","+Math.round(h)+" m1,-3 h"+e+" v"+s+" h-"+e+" z"),i.setAttribute("fill",r[a.Type][1]),i.setAttribute("stroke","brown"),i.setAttribute("stroke-width","1"),i.setAttribute("transform","rotate("+Math.round(a.Rotation[1])+", "+Math.round(d)+", "+Math.round(h)+")"),t.appendChild(i)}if(a.Freight.Amount>4){const i=document.createElementNS(this.svgNS,"path");i.setAttribute("d","M"+Math.round(d)+","+Math.round(h)+" m1,-1 h"+e+" v"+s+" h-"+e+" z"),i.setAttribute("fill",r[a.Type][1]),i.setAttribute("stroke","brown"),i.setAttribute("stroke-width","1"),i.setAttribute("transform","rotate("+Math.round(a.Rotation[1])+", "+Math.round(d)+", "+Math.round(h)+")"),t.appendChild(i)}if(a.Freight.Amount>5){const i=document.createElementNS(this.svgNS,"path");i.setAttribute("d","M"+Math.round(d)+","+Math.round(h)+" m1,1 h"+e+" v"+s+" h-"+e+" z"),i.setAttribute("fill",r[a.Type][1]),i.setAttribute("stroke","brown"),i.setAttribute("stroke-width","1"),i.setAttribute("transform","rotate("+Math.round(a.Rotation[1])+", "+Math.round(d)+", "+Math.round(h)+")"),t.appendChild(i)}}if(-1!==a.Type.toLowerCase().indexOf("flatcar_logs")&&-1!==a.Freight.Type.toLowerCase().indexOf("log")){let e=10,s=2;if(a.Freight.Amount>0){const i=document.createElementNS(this.svgNS,"path");i.setAttribute("d","M"+Math.round(d)+","+Math.round(h)+" m-6,-3 h"+e+" v"+s+" h-"+e+" z"),i.setAttribute("stroke","brown"),i.setAttribute("stroke-width","1"),i.setAttribute("transform","rotate("+Math.round(a.Rotation[1])+", "+Math.round(d)+", "+Math.round(h)+")"),t.appendChild(i)}if(a.Freight.Amount>1){const i=document.createElementNS(this.svgNS,"path");i.setAttribute("d","M"+Math.round(d)+","+Math.round(h)+" m-6,-1 h"+e+" v"+s+" h-"+e+" z"),i.setAttribute("fill",r[a.Type][1]),i.setAttribute("stroke","yellow"),i.setAttribute("stroke-width","1"),i.setAttribute("transform","rotate("+Math.round(a.Rotation[1])+", "+Math.round(d)+", "+Math.round(h)+")"),t.appendChild(i)}if(a.Freight.Amount>2){const i=document.createElementNS(this.svgNS,"path");i.setAttribute("d","M"+Math.round(d)+","+Math.round(h)+" m-6,1 h"+e+" v"+s+" h-"+e+" z"),i.setAttribute("fill",r[a.Type][1]),i.setAttribute("stroke","yellow"),i.setAttribute("stroke-width","1"),i.setAttribute("transform","rotate("+Math.round(a.Rotation[1])+", "+Math.round(d)+", "+Math.round(h)+")"),t.appendChild(i)}if(a.Freight.Amount>3){const i=document.createElementNS(this.svgNS,"path");i.setAttribute("d","M"+Math.round(d)+","+Math.round(h)+" m-6,-2 h"+e+" v"+s+" h-"+e+" z"),i.setAttribute("fill",r[a.Type][1]),i.setAttribute("stroke","yellow"),i.setAttribute("stroke-width","1"),i.setAttribute("transform","rotate("+Math.round(a.Rotation[1])+", "+Math.round(d)+", "+Math.round(h)+")"),t.appendChild(i)}if(a.Freight.Amount>4){const i=document.createElementNS(this.svgNS,"path");i.setAttribute("d","M"+Math.round(d)+","+Math.round(h)+" m-6,0 h"+e+" v"+s+" h-"+e+" z"),i.setAttribute("fill",r[a.Type][1]),i.setAttribute("stroke","yellow"),i.setAttribute("stroke-width","1"),i.setAttribute("transform","rotate("+Math.round(a.Rotation[1])+", "+Math.round(d)+", "+Math.round(h)+")"),t.appendChild(i)}if(a.Freight.Amount>5){const i=document.createElementNS(this.svgNS,"path");i.setAttribute("d","M"+Math.round(d)+","+Math.round(h)+" m-6,-1 h"+e+" v"+s+" h-"+e+" z"),i.setAttribute("fill",r[a.Type][1]),i.setAttribute("stroke","yellow"),i.setAttribute("stroke-width","1"),i.setAttribute("transform","rotate("+Math.round(a.Rotation[1])+", "+Math.round(d)+", "+Math.round(h)+")"),t.appendChild(i)}}if(-1!==a.Type.toLowerCase().indexOf("flatcar_stakes")&&-1!==a.Freight.Type.toLowerCase().indexOf("beam")){let e=10,s=2;if(a.Freight.Amount>0){const i=document.createElementNS(this.svgNS,"path");i.setAttribute("d","M"+Math.round(d)+","+Math.round(h)+" m-6,-3 h"+e+" v"+s+" h-"+e+" z"),i.setAttribute("stroke","red"),i.setAttribute("stroke-width","1"),i.setAttribute("transform","rotate("+Math.round(a.Rotation[1])+", "+Math.round(d)+", "+Math.round(h)+")"),t.appendChild(i)}if(a.Freight.Amount>1){const i=document.createElementNS(this.svgNS,"path");i.setAttribute("d","M"+Math.round(d)+","+Math.round(h)+" m-6,-1 h"+e+" v"+s+" h-"+e+" z"),i.setAttribute("fill",r[a.Type][1]),i.setAttribute("stroke","red"),i.setAttribute("stroke-width","1"),i.setAttribute("transform","rotate("+Math.round(a.Rotation[1])+", "+Math.round(d)+", "+Math.round(h)+")"),t.appendChild(i)}if(a.Freight.Amount>2){const i=document.createElementNS(this.svgNS,"path");i.setAttribute("d","M"+Math.round(d)+","+Math.round(h)+" m-6,1 h"+e+" v"+s+" h-"+e+" z"),i.setAttribute("fill",r[a.Type][1]),i.setAttribute("stroke","red"),i.setAttribute("stroke-width","1"),i.setAttribute("transform","rotate("+Math.round(a.Rotation[1])+", "+Math.round(d)+", "+Math.round(h)+")"),t.appendChild(i)}}if(-1!==a.Type.toLowerCase().indexOf("flatcar_stakes")&&-1!==a.Freight.Type.toLowerCase().indexOf("rail")){let e=a.Freight.Amount;const s=document.createElementNS(this.svgNS,"path");s.setAttribute("d","M"+Math.round(d)+","+Math.round(h)+" m-6,-2 h"+e+" v1"),s.setAttribute("stroke","black"),s.setAttribute("stroke-width","1"),s.setAttribute("transform","rotate("+Math.round(a.Rotation[1])+", "+Math.round(d)+", "+Math.round(h)+")"),t.appendChild(s);const i=document.createElementNS(this.svgNS,"path");i.setAttribute("d","M"+Math.round(d)+","+Math.round(h)+" m-6,2 h"+e+" v1"),i.setAttribute("stroke","black"),i.setAttribute("stroke-width","1"),i.setAttribute("transform","rotate("+Math.round(a.Rotation[1])+", "+Math.round(d)+", "+Math.round(h)+")"),t.appendChild(i)}}if(a.Location[2]<1e3){const s=document.createElementNS(this.svgNS,"ellipse");s.setAttribute("cx",d.toString()),s.setAttribute("cy",h.toString()),s.setAttribute("rx",(this.engineRadius/2*10).toString()),s.setAttribute("ry",(this.engineRadius/2*10).toString()),s.setAttribute("style","fill:none;stroke:red;stroke-width:10"),s.setAttribute("transform","rotate("+a.Rotation[1]+", "+(this.imx-(a.Location[0]-this.minX)/100*this.scale)+", "+(this.imy-(a.Location[1]-this.minY)/100*this.scale)+")"),t.appendChild(s);const i=document.createElementNS(this.svgNS,"text"),o=document.createTextNode("&nbsp;&nbsp;"+a.Location[2]);i.setAttribute("x",d.toString()),i.setAttribute("y",h.toString()),i.appendChild(o),t.appendChild(i);const r=document.createElement("input");r.name="underground_"+n,r.value="1",r.type="hidden",e.appendChild(r)}if(["porter_040","porter_042","eureka","climax","heisler","class70","cooke260"].indexOf(a.Type)>=0){let e=a.Name.replace(/(<([^>]+)>)/gi,"").toUpperCase();e||(e=this._capitalize(a.Type));let s=a.Rotation[1];s<0?s+=90:s-=90,this.allLabels.push([d,h]);const i=document.createElementNS(this.svgNS,"text"),o=document.createTextNode(".."+e);i.setAttribute("stroke","black"),i.setAttribute("fill","white"),i.setAttribute("font-size","1em"),i.setAttribute("x",d.toString()),i.setAttribute("y",h.toString()),i.setAttribute("transform","rotate("+s+", "+d+", "+h+")"),i.appendChild(o),t.appendChild(i)}let c="firewood",u=a.Tender.Fuelamount,l="tenderamount_";a.Type in i&&(c=i[a.Type],u=a.Freight.Amount,l="freightamount_");const p=document.createElement("tr"),m=document.createElement("td"),b=document.createElement("img");b.src="/assets/images/"+a.Type+".png",m.appendChild(b),p.appendChild(m);const g=document.createElement("td"),S=document.createElement("input");S.size=5,S.maxLength=15,S.name="name_"+n,S.value=a.Name.replace(/<\/?[^>]+(>|$)/g,"").toUpperCase(),g.appendChild(S),p.appendChild(g);const A=document.createElement("td"),f=document.createElement("input");f.size=5,f.maxLength=15,f.name="number_"+n,f.value=a.Number.replace(/<\/?[^>]+(>|$)/g,""),A.appendChild(f),p.appendChild(A);const M=document.createElement("td");let k=document.createTextNode("Unknown");"Industries"in this.json&&(k=document.createTextNode(this._nearestIndustry(a.Location,this.json.Industries))),M.appendChild(k),p.appendChild(M);const y=document.createElement("td");if("object"==typeof c){const t=document.createElement("select");for(const e of c){const s=document.createElement("option");s.text=o[e],s.value=e,s.selected=a.Freight.Type===e,t.add(s)}y.appendChild(t)}else{const t=document.createTextNode(c);y.appendChild(t)}p.appendChild(y);const E=document.createElement("td"),w=document.createElement("input");w.name=l+n,w.value=u,w.size=2,w.maxLength=4,E.appendChild(w),p.appendChild(E),s.appendChild(p),n++}this.shapes.push(t)}getIndustries(){if(!("Industries"in this.json))return;const t=document.getElementById("industriesTable");let e=0;for(const s of this.json.Industries){let i="",o=0,r=0,n=0,a=[],d=[];switch(s.Type){case 1:s.EductsStored.pop(),s.EductsStored.pop(),s.EductsStored.pop(),s.EductsStored.pop(),d=["logs_p.svg","cordwood_p.svg","cordwood_p.svg","logs_p.svg"],i="Logging Camp",o=0,r=-70,n=-30;break;case 2:i="Sawmill",s.EductsStored.pop(),s.EductsStored.pop(),s.EductsStored.pop(),s.ProductsStored.pop(),s.ProductsStored.pop(),d=["lumber_p.svg","beams_p.svg"],a=["logs_p.svg"],r=-35,n=-15,o=45;break;case 3:i="Smelter",s.EductsStored.pop(),s.EductsStored.pop(),s.ProductsStored.pop(),s.ProductsStored.pop(),d=["iron_p.svg","rails_p.svg"],a=["ironore_p.svg","cordwood_p.svg"],o=90;break;case 4:i="Ironworks",s.EductsStored.pop(),s.EductsStored.pop(),s.ProductsStored.pop(),s.ProductsStored.pop(),d=["pipes_p.svg","tools_p.svg"],a=["iron_p.svg","coal_p.svg"],o=90;break;case 5:i="Oilfield",s.EductsStored.pop(),s.ProductsStored.pop(),s.ProductsStored.pop(),s.ProductsStored.pop(),a=["pipes_p.svg","beams_p.svg","tools_p.svg"],d=["oil_p.svg"],o=0;break;case 6:i="Refinery",s.EductsStored.pop(),s.ProductsStored.pop(),s.ProductsStored.pop(),s.ProductsStored.pop(),a=["oil_p.svg","pipes_p.svg","lumber_p.svg"],d=["barrels_p.svg","barrels_p.svg"],o=0;break;case 7:i="Coal Mine",s.EductsStored.pop(),s.EductsStored.pop(),s.ProductsStored.pop(),s.ProductsStored.pop(),s.ProductsStored.pop(),a=["beams_p.svg","rails_p.svg"],d=["coal_p.svg"],o=-20,r=-20,n=20;break;case 8:i="Iron Mine",s.EductsStored.pop(),s.EductsStored.pop(),s.ProductsStored.pop(),s.ProductsStored.pop(),s.ProductsStored.pop(),a=["lumber_p.svg","beams_p.svg"],d=["ironore_p.svg"],o=45,n=50,r=-20;break;case 9:i="Freight Depot",s.EductsStored.pop(),s.EductsStored.pop(),s.EductsStored.pop(),s.EductsStored.pop(),s.ProductsStored.pop(),s.ProductsStored.pop(),s.ProductsStored.pop(),s.ProductsStored.pop(),o=90;break;case 10:s.EductsStored.pop(),s.EductsStored.pop(),s.EductsStored.pop(),a=["cordwood_p.svg"],i="F#"+e,o=s.Rotation[1]>0?s.Rotation[1]-90:s.Rotation[1]+90;const t=this.imx-(s.Location[0]-this.minX)/100*this.scale,h=this.imy-(s.Location[1]-this.minY)/100*this.scale,c=document.createElementNS(this.svgNS,"path");c.setAttribute("transform","rotate("+Math.round(s.Rotation[1])+", "+t+", "+h+")"),c.setAttribute("d","M"+t+","+h+" m-18,-15 l10,0 l0,30 l-10,0 z"),c.setAttribute("fill","orange"),c.setAttribute("stroke","brown"),this.shapes.push(c),r=-20,n=0;break;default:console.log("Unknown industry: "+JSON.stringify(s,null,2))}const h=document.createElementNS(this.svgNS,"text"),c=document.createTextNode(i);h.setAttribute("x",(this.imx-(s.Location[0]-this.minX)/100*this.scale).toString()),h.setAttribute("y",(this.imy-(s.Location[1]-this.minY)/100*this.scale).toString()),h.setAttribute("transform","rotate("+o+", "+(this.imx-(s.Location[0]-this.minX)/100*this.scale+r)+", "+(this.imy-(s.Location[1]-this.minY)/100*this.scale+n)+")"),h.appendChild(c),this.shapes.push(h);const u=document.createElement("tr");u.setAttribute("class","export__educts");const l=document.createElement("td"),p=document.createTextNode(i+" Educts");l.appendChild(p),u.appendChild(l);for(let t=0;t<s.EductsStored.length;t++){const i=document.createElement("td"),o=document.createElement("input");if(o.size=5,o.maxLength=15,o.name="educt"+t+"_"+e,o.value=s.EductsStored[t],void 0!==a[t]){const e=document.createElement("img");e.setAttribute("style","float:right"),e.setAttribute("src","/assets/images/"+a[t]),e.setAttribute("height","30"),i.appendChild(e)}i.appendChild(o),u.appendChild(i)}t.appendChild(u);const m=document.createElement("tr");m.setAttribute("class","export__products");const b=document.createElement("td"),g=document.createTextNode(i+" Products");b.appendChild(g),m.appendChild(b);for(let t=0;t<s.ProductsStored.length;t++){const i=document.createElement("td"),o=document.createElement("input");if(o.size=5,o.maxLength=15,o.name="product"+t+"_"+e,o.value=s.ProductsStored[t],void 0!==d[t]){const e=document.createElement("img");e.setAttribute("style","float:right"),e.setAttribute("src","/assets/images/"+d[t]),e.setAttribute("height","30"),i.appendChild(e)}i.appendChild(o),m.appendChild(i)}t.appendChild(m),e+=1}}getWaterTowers(){if("Watertowers"in this.json)for(const t of this.json.Watertowers){const e=this.imx-(t.Location[0]-this.minX)/100*this.scale,s=this.imy-(t.Location[1]-this.minY)/100*this.scale,i=document.createElementNS(this.svgNS,"path");i.setAttribute("transform","rotate("+Math.round(t.Rotation[1])+", "+e+", "+s+")"),i.setAttribute("d","M"+e+","+s+" m -5,-5 l10,0 l0,3 l3,0 l0,4 l-3,0 l0,3 l-10,0 z"),i.setAttribute("fill","lightblue"),i.setAttribute("stroke","black"),i.setAttribute("stroke-width","1"),this.shapes.push(i);const o=document.createElementNS(this.svgNS,"circle");o.setAttribute("cx",e.toString()),o.setAttribute("cy",s.toString()),o.setAttribute("r","3"),o.setAttribute("fill","blue"),this.shapes.push(o)}}getReplantableTrees(){if(!("Removed"in this.json))return;const t=document.createElementNS(this.svgNS,"g");t.setAttribute("class","trees_default display_hide");const e=document.createElementNS(this.svgNS,"g");e.setAttribute("class","trees_user display_hide");for(let s=0;s<this.json.Removed.Vegetation.length;s++){const i=this.json.Removed.Vegetation[s],o=Math.floor((2e5+i[0])/1e5),r=Math.floor((2e5+i[1])/1e5);let n=8e7;try{for(const t of this.json.Splines)if(0===t.Type||4===t.Type)for(const e of t.Segments)-1===e.CX.indexOf(o)&&-1===e.CY.indexOf(r)&&(e.LocationCenter.X<i[0]-6e3||e.LocationCenter.X>i[0]+6e3||e.LocationCenter.Y<i[1]-6e3||e.LocationCenter.Y>i[1]+6e3||(n=Math.min(n,this._dist(i,e.LocationCenter))))}catch(t){}if(n>700){const o=this.imx-(i[0]-this.minX)/100*this.scale,r=this.imy-(i[1]-this.minY)/100*this.scale,n=document.createElementNS(this.svgNS,"circle");n.setAttribute("cx",o.toString()),n.setAttribute("cy",r.toString()),n.setAttribute("r","6"),n.setAttribute("stroke","darkgreen"),n.setAttribute("stroke-width","2"),s<this.initialTreesDown?(n.setAttribute("fill","orange"),t.appendChild(n)):(n.setAttribute("fill","green"),e.appendChild(n))}}this.shapes.push(t),this.shapes.push(e)}_getDistanceToNearestLabel(t){let e=8e3;for(const s of this.allLabels)e=Math.min(e,Math.sqrt(Math.pow(t[0]-s[0],2)+Math.pow(t[1]-s[1],2)));return e}_round(t,e){return Number(Math.round(t+"e"+e)+"e-"+e)}_rad2deg(t){return t*(180/Math.PI)}_deg2rad(t){return t*(Math.PI/180)}_capitalize(t){return String(t).charAt(0).toUpperCase()+t.slice(1).toLowerCase()}_nearestIndustry(t,e){let s=8e5,i=0;for(const o of e)if(o.Type<10){const e=this._dist(o.Location,t);e<s&&(s=e,i=o.Type)}switch(i){case 1:name="Logging Camp";break;case 2:name="Sawmill";break;case 3:name="Smelter";break;case 4:name="Ironworks";break;case 5:name="Oilfield";break;case 6:name="Refinery";break;case 7:name="Coal Mine";break;case 8:name="Iron Mine";break;case 9:name="Freight Depot"}return name}_dist(t,e){return Math.sqrt(Math.pow(t[0]-e.X,2)+Math.pow(t[1]-e.Y,2)).valueOf()}}